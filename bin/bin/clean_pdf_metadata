#!/usr/bin/env python3

# requires exiftool and qpdf
# macos:
# brew install exiftool
# brew install qpdf

import subprocess
from pathlib import Path


def get_dirs(wd,seen=set()):
    if wd in seen:
        return []
    seen.add(wd)
    dirs = []
    dirs.append(wd)
    for dir in Path(wd).glob("*"):
        if dir.is_dir() and not dir.name.startswith("."):
            res = get_dirs(dir,seen)
            for item in res:
                dirs.append(item)
    return dirs

def pdf(dir):
    files = list(Path(dir).glob('*.pdf'))
    for file in files:
        path = file.resolve()
        exiftool_cmd = ["exiftool","-all=","-overwrite_original",f"{path}"]
        qpdf_cmd = ["qpdf","--linearize","--replace-input",f"{path}"]

        subprocess.run(exiftool_cmd)
        subprocess.run(qpdf_cmd)
        print(f"Cleaned metadata of {path}.")

def main():
    dirs = get_dirs(Path.cwd())
    for dir in dirs:
        pdf(dir)


if __name__ == "__main__":
    main()
