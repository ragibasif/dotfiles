#!/usr/bin/env python3

from pathlib import Path
import re


def get_dirs(wd,seen=set()):
    if wd in seen:
        return []
    seen.add(wd)
    dirs = []
    dirs.append(wd)
    for dir in Path(wd).glob("*"):
        if dir.is_dir() and not dir.name.startswith("."):
            res = get_dirs(dir,seen)
            for item in res:
                dirs.append(item)
    return dirs

def fix_name(text):
    buf = list(re.sub(r"[^a-zA-Z0-9]", "_", text, flags=re.UNICODE))
    for i in range(1, len(buf)):
        if buf[i] == "_" and buf[i - 1] == "_":
            buf[i - 1] = ""
    if len(buf) > 0:
        if buf[0] == "_":
            buf[0] = ""
        if buf[-1] == "_":
            buf[-1] = ""

    return "".join(buf)

def prettify(wd=None):
    dirs = []
    if not wd:
        dirs=get_dirs(Path.cwd())
    else:
        dirs=get_dirs(wd)
    for dir in dirs:
        for file in Path(dir).iterdir():
            old_path = Path(file)
            if file.is_file() and not file.name.startswith("."):
                ext = file.suffix
                file_name = file.stem
                new_file_name = fix_name(file_name)+ext
                new_path = old_path.with_name(new_file_name)
                if old_path != new_path:
                    old_path.rename(new_path)
                    print(f"Renamed: {old_path.name} -> {new_file_name}")
    for i in range(len(dirs)):
        dir_name = dirs[i].stem
        new_dir_name = fix_name(dir_name)
        old_path = Path(dirs[i])
        new_path = old_path.with_name(new_dir_name)
        if old_path != new_path:
            old_path.rename(new_path)
            print(f"Renamed: {old_path.name} -> {new_dir_name}")

def test():
    def test_fix_name():
        test_cases = [
            ("Hello-World!123", "Hello_World_123"),
            ("Test@Case#456", "Test_Case_456"),
            ("a_b_c!@#$", "a_b_c"),
            ("!!!###$$$", ""),
            ("", ""),
            ("NoSpecialChars", "NoSpecialChars"),
        ]
        for text, want in test_cases:
            got = fix_name(text)
            assert got == want, f"Failed for {text}: {got=} != {want=}"
    test_fix_name()

    import subprocess
    import random
    import string
    UNICODE = "ä½ å¥½_ðŸš€_Ã©_ÃŸ_Î”_Ï€"
    SYMBOLS = " .-_!@#$%^&()[]{}"
    ASCII = string.ascii_letters + string.digits
    random.seed(69)

    test_dir = "tests"

    def make_name(length=12):
        all_chars = UNICODE + SYMBOLS + ASCII
        return "".join(random.choices(all_chars, k=length)).strip()

    def make_tree(base_path, depth=4):
        base = Path(base_path)
        base.mkdir(exist_ok=True)

        for _ in range(4): # Create 4 items per level
            name = make_name()
            current_path = base / name

            try:
                if random.random() > 0.3 and depth > 0:
                    # Create a Folder
                    current_path.mkdir(exist_ok=True)
                    make_tree(current_path, depth - 1)
                else:
                    # Create a File with a random extension
                    ext = random.choice([".txt", ".tmp", ".log", "..hidden"])
                    (base / f"{name}{ext}").touch()
            except OSError:
                continue

    make_tree(test_dir)
    prettify(test_dir)
    subprocess.run(["rm","-rf",f"{test_dir}"])


if __name__ == "__main__":
    prettify()
