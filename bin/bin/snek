#!/usr/bin/env python3
"""
Name: snek
Description: A lightweight CLI utility that sanitizes file and directory names in the current working directory by replacing non-alphanumeric characters with underscores.
Repository: https://github.com/ragibasif/snek
Author: Ragib Asif
Email:  ragibasif@tuta.io
Date:   2026-02-24
Version: 1.0.0

Copyright (c) 2026 Ragib Asif
All rights reserved.

Licensed under the MIT License. See LICENSE file in the project root for details.
"""

import argparse
import datetime
import logging
import re
from pathlib import Path


def setup_logging(level: str) -> None:
    logging.basicConfig(
        level=getattr(logging, level.upper(), logging.INFO),
        format="[snek] %(asctime)s [%(levelname)s] - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S",
    )


logger = logging.getLogger(__name__)


def parse_args() -> argparse.Namespace:
    """Parse command-line arguments."""
    parser = argparse.ArgumentParser(
        description="Snek",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  snek
  snek --verbose
  snek --recursive
  snek --verbose --recursive
        """,
    )

    parser.add_argument(
        "-v",
        "--verbose",
        action="store_true",
        help="Enable verbose (DEBUG) output",
    )

    parser.add_argument(
        "-r",
        "--recursive",
        action="store_true",
        help="Enable recursive editing",
    )

    return parser.parse_args()



def clean(text: str) -> str:
    """
    Replaces non-ascii and white space characters with underscores.
    Returns empty string if the result of replacement operations results
    in only underscores.
    """
    res = re.sub(r"[^a-zA-Z0-9]", "_", text, flags=re.UNICODE)
    res = re.sub(r"_+", "_", res)
    res = res.strip("_")
    return res


def paths(dir: Path ) -> list[Path]:
    """
    Non-recursive
    Get all the paths in the working directory except hidden files/dirs
    """
    buf: list[Path] = []
    for item in Path(dir).glob("*"):
        if not item.name.startswith("."):
            buf.append(item)
    return buf


def fix(path: Path) -> None:
    dt: str = datetime.datetime.now(tz=datetime.timezone.utc).strftime(
        format="%Y%m%d%H%M%S%f%Z"
    )
    name = clean(path.stem)
    if len(name) == 0:
        name = dt
    ext = path.suffix
    new_path = path.parent / f"{name}{ext}"
    if not new_path.exists():
        path.rename(new_path)
        logger.info(f"Renamed '{str(path)}' -> '{str(new_path)}'")
    else:
        logger.info(f"'{str(new_path)}' already exists")


def non_recursive(path: Path) -> None:
    buf = paths(path)
    for item in buf:
        fix(item)


def recursive(path: Path) -> None:
    buf: list[Path] = paths(path)
    for item in buf:
        if item.is_dir():
            recursive(item)
        fix(item)


def main() -> None:
    args = parse_args()

    log_level = "DEBUG" if args.verbose else "INFO"
    setup_logging(log_level)

    logger.debug(f"Arguments: {args}")

    cwd: Path = Path.cwd()

    if args.recursive:
        recursive(cwd)
    else:
        non_recursive(cwd)


if __name__ == "__main__":
    main()
